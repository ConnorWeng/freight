<script type="text/javascript" src="__PUBLIC__/datepicker/js/bootstrap-datepicker.js"></script>
<link rel="stylesheet" href="__PUBLIC__/datepicker/css/datepicker.css" type="text/css" media="screen" />
<script>
$(document).ready(function () {
    var actionFlag = 0;

    $('.handsontable').handsontable({
        startRows: 0,
        columnSorting: true,
        colHeaders: function (col) {
            switch (col) {
            case 0:
                return '选择';
            case 1:
                return '操作日期';
            case 2:
                return '操作类型';
            case 3:
                return '入库货值';
            case 4:
                return '出货货值';
            case 5:
                return '收款金额';
            case 6:
                return '应收款金额';
            case 7:
                return '收款／放贷比';
            case 8:
                return '所属订单编号';
            case 9:
                return '经销商';
            }
        },
        columns: [{renderer: radioRenderer}, {data: 'BUILD_DATE'}, {renderer: inOutTypeRenderer}, {data: 'IN_AMOUNT'},
                  {data: 'OUT_AMOUNT'}, {data: 'RECEIVE_AMOUNT'}, {data: ''},
                  {data: ''}, {data: 'ORDER_NO'}, {data: ''}],
        contextMenu: false
    });

    $('.in_date_input').datepicker({
        format: 'mm/dd/yyyy'
    });

    $('.out_date_input').datepicker({
        format: 'mm/dd/yyyy'
    });

    $('.add').on('click', function (event) {
        event.preventDefault();
        actionFlag = 0;
    });

    $('.edit').on('click', function (event) {
        event.preventDefault();
        actionFlag = 1;
        var $radio = $('input[name=czxx-radio]:checked');
        if ($radio.length > 0) {
            var ht = $('#czxxtable').data('handsontable'),
            row = $radio.attr('row'),
            rowData = ht.getDataAtRow(row);
            $('.loan_no_input').val(rowData['LOAN_NO']);
            $('.supplier_input').val(rowData['SUPPLIER']);
            $('.loan_amount_input').val(rowData['LOAN_AMOUNT']);
            $('.loan_type_input').val(rowData['LOAN_TYPE']);
            $('.init_security_amount_input').val(rowData['INIT_SECURITY_AMOUNT']);
            $('.loan_date_input').val(rowData['LOAN_DATE']);
            $('.loan_end_date_input').val(rowData['LOAN_END_DATE']);
            $('.currency_input').val(rowData['CURRENCY']);
            $('.end_flag_input').val(rowData['END_FLAG']);
        } else {
            alert('未选择');
            return false;
        }
    });

    $('.del').on('click', function (event) {
        event.preventDefault();
        var $radio = $('input[name=czxx-radio]:checked');
        if ($radio.length > 0) {
            var ht = $('#czxxtable').data('handsontable'),
            row = $radio.attr('row'),
            rowData = ht.getDataAtRow(row);
            if (confirm('确认删除？')) {
                delCZXX(rowData['LOAN_NO']);
            }
        } else {
            alert('未选择');
        }
    });

    $('.search-btn').on('click', function (event) {
        event.preventDefault();
        query();
    });

    function query() {
        $.ajax({
            url: '{:U('KCXX/query')}',
            data: {
                'in_out_type': $('.in_out_type').val(),
                'order_no': $('order_no').val()
            },
            success: function (data) {
                var table = $('.handsontable').data('handsontable');
                table.loadData(data);
            }
        });
    }

    $('.addInBtn').on('click', function (event) {
        event.preventDefault();
        addIn();
    });

    function addIn() {
        $.ajax({
            url: '{:U('KCXX/addIn')}',
            data: {
                'in_date': $('.in_date_input').val(),
                'in_amount': $('.in_amount_input').val(),
                'order_no': $('.order_no_input').val()
            },
            success: function (data) {
                if (data == '1') {
                    alert('新增成功');
                    $('.search-btn').click();
                } else {
                    alert('新增失败');
                }
            }
        });
    }

    $('.addOutBtn').on('click', function (event) {
        event.preventDefault();
        addOut();
    });

    function addOut() {
        $.ajax({
            url: '{:U('KCXX/addOut')}',
            data: {
                'out_date': $('.out_date_input').val(),
                'out_amount': $('.out_amount_input').val(),
                'receive_amount': $('.receive_amount_input').val(),
                'receive_type': $('.receive_type_input').val(),
                'order_no': $('.order_no_input').val()
            },
            success: function (data) {
                if (data == '1') {
                    alert('新增成功');
                    $('.search-btn').click();
                } else {
                    alert('新增失败');
                }
            }
        });
    }

    function editCZXX() {
        $.ajax({
            url: '{:U('CZXX/editCZXX')}',
            data: {
                'loan_no': $('.loan_no_input').val(),
                'supplier': $('.supplier_input').val(),
                'loan_amount': $('.loan_amount_input').val(),
                'loan_type': $('.loan_type_input').val(),
                'init_security_amount': $('.init_security_amount_input').val(),
                'loan_date': $('.loan_date_input').val(),
                'loan_end_date': $('.loan_end_date_input').val(),
                'currency': $('.currency_input').val(),
                'end_flag': $('.end_flag_input').val()
            },
            success: function (data) {
                if (data == '1') {
                    alert('修改成功');
                    $('.search-btn').click();
                } else {
                    alert('修改失败');
                }
            }
        });
    }

    function delCZXX(loanNo) {
        $.ajax({
            url: '{:U('CZXX/delCZXX')}',
            data: {
                'loan_no': loanNo
            },
            success: function (data) {
                if (data == '1') {
                    alert('删除成功');
                    $('.search-btn').click();
                } else {
                    alert('删除失败');
                }
            }
        });
    }

});
</script>
